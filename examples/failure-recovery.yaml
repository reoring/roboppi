# Failure Recovery — error handling demo
# Demonstrates retry / continue / abort policies
name: failure-recovery
version: "1"
description: "Demonstrate on_failure policy behavior"
timeout: "3m"
concurrency: 2

steps:
  # This step fails on the first attempt and succeeds on retry.
  flaky-step:
    description: "Flaky step (fails once, then succeeds)"
    worker: CUSTOM
    instructions: |
      ATTEMPT_FILE=".flaky-attempt"
      if [ ! -f "$ATTEMPT_FILE" ]; then
        echo "1" > "$ATTEMPT_FILE"
        echo "First attempt — simulating failure"
        exit 1
      fi
      ATTEMPT=$(cat "$ATTEMPT_FILE")
      echo "Attempt $((ATTEMPT + 1)) — succeeding this time"
      echo "Flaky step output" > flaky-result.txt
      rm "$ATTEMPT_FILE"
    capabilities: [EDIT, RUN_COMMANDS]
    timeout: "30s"
    max_retries: 2
    on_failure: retry
    outputs:
      - name: flaky-output
        path: "flaky-result.txt"

  # This step always fails, but uses `continue` so it doesn't block downstream steps.
  optional-lint:
    description: "Lint check (continue on failure)"
    worker: CUSTOM
    instructions: |
      echo "Running lint..."
      echo "WARNING: 3 lint issues found" > lint-result.txt
      echo "Lint failed (non-critical)"
      exit 1
    capabilities: [READ]
    timeout: "30s"
    on_failure: continue
    outputs:
      - name: lint-report
        path: "lint-result.txt"

  # Depends on both flaky-step and optional-lint.
  # flaky-step succeeds after retry; optional-lint fails (continue).
  summary:
    description: "Summarize results"
    worker: CUSTOM
    depends_on: [flaky-step, optional-lint]
    instructions: |
      echo "# Summary" > summary.md
      echo "" >> summary.md
      if [ -f flaky-output/flaky-result.txt ]; then
        echo "## Flaky Step: RECOVERED" >> summary.md
        cat flaky-output/flaky-result.txt >> summary.md
      else
        echo "## Flaky Step: no output" >> summary.md
      fi
      echo "" >> summary.md
      if [ -f lint-report/lint-result.txt ]; then
        echo "## Lint: FAILED (continued)" >> summary.md
        cat lint-report/lint-result.txt >> summary.md
      else
        echo "## Lint: no output (failed)" >> summary.md
      fi
      echo "" >> summary.md
      echo "Workflow completed with partial failures." >> summary.md
      cat summary.md
    capabilities: [READ, EDIT]
    inputs:
      - from: flaky-step
        artifact: flaky-output
      - from: optional-lint
        artifact: lint-report
    timeout: "30s"
    outputs:
      - name: final-summary
        path: "summary.md"
