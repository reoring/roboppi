# Agent PR Loop Daemon â€” manual kick + workflow loop
#
# Start (from repo root):
#   bun run src/daemon/cli.ts examples/daemon/agent-pr-loop.yaml --verbose
#
# Start (from any directory):
#   ROBOPPI_ROOT=/path/to/roboppi \
#     bun run --cwd "$ROBOPPI_ROOT" src/daemon/cli.ts examples/daemon/agent-pr-loop.yaml \
#       --workspace "$ROBOPPI_ROOT" --verbose
#
# Kick it (in another terminal):
#   mkdir -p .roboppi-loop
#   date +%s > .roboppi-loop/kick.txt

name: agent-pr-loop-daemon
version: "1"
description: "Manual kick daemon that runs the agent-pr-loop workflow"

# Keep workflow YAML resolvable relative to this repo
workspace: "."
state_dir: "/tmp/roboppi-daemon-agent-pr-loop/.daemon-state"
max_concurrent_workflows: 1

events:
  kick:
    type: command
    command: "cat .roboppi-loop/kick.txt 2>/dev/null || echo 0"
    interval: "2s"
    trigger_on: change

triggers:
  run-loop:
    on: kick
    workflow: "examples/agent-pr-loop.yaml"
    cooldown: "5s"
    on_workflow_failure: ignore

    # Command event emits a baseline event on first run (changed=false).
    # Gate execution so this trigger behaves like a true manual kick.
    evaluate:
      worker: CUSTOM
      instructions: |
        set -euo pipefail
        echo "${ROBOPPI_EVENT:-}" | grep -q '"changed":true'
      capabilities: [READ, RUN_COMMANDS]
      timeout: "5s"

    context:
      last_result: true
      event_payload: true

    analyze:
      worker: CUSTOM
      instructions: |
        set -e
        echo "=== Agent PR Loop (last run) ===" > .roboppi-loop/daemon-summary.txt
        echo "Status: $ROBOPPI_WORKFLOW_STATUS" >> .roboppi-loop/daemon-summary.txt
        echo "Trigger: $ROBOPPI_TRIGGER_ID" >> .roboppi-loop/daemon-summary.txt
        echo "At: $ROBOPPI_TIMESTAMP" >> .roboppi-loop/daemon-summary.txt
        if [ -f .roboppi-loop/pr-url.txt ]; then
          echo "PR: $(cat .roboppi-loop/pr-url.txt)" >> .roboppi-loop/daemon-summary.txt
        fi
        cat .roboppi-loop/daemon-summary.txt
      capabilities: [READ, EDIT, RUN_COMMANDS]
      timeout: "30s"
      outputs:
        - name: summary
          path: ".roboppi-loop/daemon-summary.txt"
